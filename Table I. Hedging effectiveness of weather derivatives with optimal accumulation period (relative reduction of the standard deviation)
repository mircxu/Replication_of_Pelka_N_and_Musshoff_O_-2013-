# Load required libraries
library(tidyverse)
library(gridExtra)
library(grid)

# Load all datasets
precipitation <- read_csv('Hedging_Effectiveness_Precipitation.csv') %>% 
  select(district_no, Hedging_Effectiveness) %>%
  rename(Precipitation = Hedging_Effectiveness)

temperature <- read_csv('Hedging_Effectiveness_Temperature.csv') %>% 
  select(district_no, Hedging_Effectiveness) %>%
  rename(Temperature = Hedging_Effectiveness)

mixed_diff <- read_csv('Tailored_hedging_different_stations.csv') %>% 
  rename(district_no = district) %>%
  select(district_no, Hedging_Effectiveness) %>%
  rename(Mixed_Different = Hedging_Effectiveness)

mixed_same <- read_csv('Tailored_hedging_same_stations.csv') %>% 
  rename(district_no = district) %>%
  select(district_no, Hedging_Effectiveness) %>%
  rename(Mixed_Same = Hedging_Effectiveness)

two_simple <- read_csv('hedging_effectiveness_two_simple_indices.csv') %>% 
  select(district_no, Hedging_Effectiveness) %>%
  rename(Two_Simple = Hedging_Effectiveness)

# Step 1: Merge all datasets
merged_summary <- precipitation %>%
  full_join(temperature, by = "district_no") %>%
  full_join(mixed_diff, by = "district_no") %>%
  full_join(mixed_same, by = "district_no") %>%
  full_join(two_simple, by = "district_no") %>%
  arrange(district_no)

# Replace NA with zeros
merged_summary[is.na(merged_summary)] <- 0

# Final formatting
merged_summary_final <- merged_summary %>%
  rename(
    `District Number` = district_no,
    `Column 1: Precipitation-based index (%)` = Precipitation,
    `Column 2: Temperature-based index (%)` = Temperature,
    `Column 3: Mixed index at two stations (%)` = Mixed_Different,
    `Column 4: Mixed index at same station (%)` = Mixed_Same,
    `Column 5: Two simple indices (%)` = Two_Simple
  )

# Step 2: Calculate summary statistics using reframe() and fix data types
summary_stats <- reframe(
  merged_summary_final,
  `District Number` = c("Average", "Minimum", "Maximum", "SD"),
  `Column 1: Precipitation-based index (%)` = c(
    mean(`Column 1: Precipitation-based index (%)`, na.rm = TRUE),
    min(`Column 1: Precipitation-based index (%)`, na.rm = TRUE),
    max(`Column 1: Precipitation-based index (%)`, na.rm = TRUE),
    sd(`Column 1: Precipitation-based index (%)`, na.rm = TRUE)
  ),
  `Column 2: Temperature-based index (%)` = c(
    mean(`Column 2: Temperature-based index (%)`, na.rm = TRUE),
    min(`Column 2: Temperature-based index (%)`, na.rm = TRUE),
    max(`Column 2: Temperature-based index (%)`, na.rm = TRUE),
    sd(`Column 2: Temperature-based index (%)`, na.rm = TRUE)
  ),
  `Column 3: Mixed index at two stations (%)` = c(
    mean(`Column 3: Mixed index at two stations (%)`, na.rm = TRUE),
    min(`Column 3: Mixed index at two stations (%)`, na.rm = TRUE),
    max(`Column 3: Mixed index at two stations (%)`, na.rm = TRUE),
    sd(`Column 3: Mixed index at two stations (%)`, na.rm = TRUE)
  ),
  `Column 4: Mixed index at same station (%)` = c(
    mean(`Column 4: Mixed index at same station (%)`, na.rm = TRUE),
    min(`Column 4: Mixed index at same station (%)`, na.rm = TRUE),
    max(`Column 4: Mixed index at same station (%)`, na.rm = TRUE),
    sd(`Column 4: Mixed index at same station (%)`, na.rm = TRUE)
  ),
  `Column 5: Two simple indices (%)` = c(
    mean(`Column 5: Two simple indices (%)`, na.rm = TRUE),
    min(`Column 5: Two simple indices (%)`, na.rm = TRUE),
    max(`Column 5: Two simple indices (%)`, na.rm = TRUE),
    sd(`Column 5: Two simple indices (%)`, na.rm = TRUE)
  )
)

# Convert "District Number" to character for both tables
merged_summary_final <- merged_summary_final %>%
  mutate(`District Number` = as.character(`District Number`))

summary_stats <- summary_stats %>%
  mutate(`District Number` = as.character(`District Number`))

# Step 3: Combine summary statistics and district data
final_table <- bind_rows(summary_stats, merged_summary_final)

# Step 4: Save the final table to a CSV file
write_csv(final_table, "final_summary_statistics_with_top_summary.csv")
