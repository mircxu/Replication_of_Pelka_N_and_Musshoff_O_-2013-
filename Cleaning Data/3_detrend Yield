library(ggplot2)
library(dplyr)
library(readr)

# Load the data
data <- read_csv("filtered_data.csv")

# Filter data for winter wheat (ww)
data_ww <- data %>% filter(var == "ww")

# Initialize a list to store slopes
district_slopes <- list()

# Loop through each district to calculate the slope (yield increase per year)
for (district in unique(data_ww$district)) {
  district_data <- data_ww %>% filter(district == !!district)
  
  # Fit the linear model: value ~ year
  model <- lm(value ~ year, data = district_data)
  
  # Extract the slope (coefficient for year)
  slope <- coef(model)["year"]
  
  # Store the district and slope
  district_slopes[[district]] <- slope
}

# Convert the slopes list to a data frame
district_slopes_df <- data.frame(
  district = names(district_slopes),
  slope = unlist(district_slopes)
)

# Calculate average slope, minimum slope, and maximum slope
average_slope_2021 <- mean(district_slopes_df$slope)
min_slope_2021 <- min(district_slopes_df$slope)
max_slope_2021 <- max(district_slopes_df$slope)

# Merge the calculated slopes back into the original data without altering original columns
data_ww <- data_ww %>%
  left_join(district_slopes_df, by = "district") %>%
  mutate(Yield_Detrended_2021 = value - slope * (year - 2021))

# Calculate the overall de-trended average yield for all years combined
overall_average_detrended_yield_2021 <- mean(data_ww$Yield_Detrended_2021, na.rm = TRUE)

# Print the results in the requested format
cat("The farms analyzed indicate an average yield increase of", round(average_slope_2021, 2), 
    "dt/ha and year with a fluctuation range from", round(min_slope_2021, 2), 
    "to", round(max_slope_2021, 2), "dt/ha and generate a de-trended average winter wheat yield of", 
    round(overall_average_detrended_yield_2021, 2), "dt/ha in the years examined.\n")
cat("We did not identify any significant trends in the weather data.\n")

# Save the de-trended data to a new CSV file without altering the original structure
write_csv(data_ww, "filtered_data_detrended.csv")
