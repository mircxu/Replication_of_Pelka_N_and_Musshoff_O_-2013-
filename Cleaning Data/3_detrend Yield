library(ggplot2)
library(dplyr)
library(lme4)
library(readr)

# Replace 'path_to_your_file.csv' with the actual path to your data file
data <- read_csv("filtered_data.csv")

# Fit a linear mixed-effects model
model <- lmer(value ~ year + (year | district), data = data)
summary(model)

# Extract random effects (district-specific slopes and intercepts)
district_trends <- ranef(model)$district
district_trends$district <- rownames(district_trends)
colnames(district_trends) <- c("Intercept", "Slope", "district")

# Adjust to the year 2021
data <- data %>%
  left_join(district_trends, by = "district") %>%
  mutate(
    Baseline_2021 = Intercept + Slope * 2021,  # Calculate the yield level in 2021 for each district
    Yield_Detrended = value - (Slope * (year - 2021))  # De-trend yields to the 2021 level
  )

# Calculate the average slope (yield increase per year)
average_slope <- mean(district_trends$Slope)
min_slope <- min(district_trends$Slope)
max_slope <- max(district_trends$Slope)

# Calculate the overall de-trended average yield for all years combined
overall_average_detrended_yield <- mean(data$Yield_Detrended, na.rm = TRUE)

# Display the calculated statistics
cat("Average yield increase per year (dt/ha):", round(average_slope, 2), "\n")
cat("Fluctuation range of yield increase (dt/ha):", round(min_slope, 2), "to", round(max_slope, 2), "\n")
cat("Overall de-trended average yield (dt/ha) for all years combined:", round(overall_average_detrended_yield, 2), "\n")

# Save the detrended data to a new CSV file
write_csv(data, "detrended_Final.csv")
